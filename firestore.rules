rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isSignedIn() {
      return request.auth != null;
    }
    
    // Helper function to check if user is league admin
    function isLeagueAdmin(leagueId) {
      return isSignedIn() && 
             get(/databases/$(database)/documents/leagues/$(leagueId)).data.admin == request.auth.uid;
    }
    
    // Helper function to check if user is in the league
    // NOTE: Firestore rules can't easily check arrays of objects
    // Since the app filters by leagueId in queries, we allow any authenticated user
    // The real security is that users can only find their own league via the app logic
    function isInLeague(leagueId) {
      return isSignedIn();
    }

    // Helper to check if a user is banned from league chat
    function isChatBanned(leagueId) {
      return isSignedIn() &&
             exists(/databases/$(database)/documents/leagues/$(leagueId)/chatBans/$(request.auth.uid));
    }
    
    // Leagues collection
    match /leagues/{leagueId} {
      // Anyone authenticated can read leagues (to find their league)
      allow read: if isSignedIn();
      
      // Only authenticated users can create leagues (they become admin)
      allow create: if isSignedIn() && 
                      request.resource.data.admin == request.auth.uid;
      
      // Only league admin can update or delete
      allow update, delete: if isLeagueAdmin(leagueId);
      
      // Team scores - anyone in league can read, only scoring engine should write
      match /teamScores/{scoreId} {
        allow read: if isInLeague(leagueId);
        allow write: if isLeagueAdmin(leagueId); // Only admin for manual testing
      }
      
      // Player daily scores - anyone in league can read
      match /playerDailyScores/{scoreId} {
        allow read: if isInLeague(leagueId);
        allow write: if isLeagueAdmin(leagueId); // Only admin for manual testing
      }
      
      // Live stats - anyone in league can read, anyone in league can write (for manual refresh)
      match /liveStats/{statId} {
        allow read: if isInLeague(leagueId);
        allow write: if isInLeague(leagueId); // Allow any league member to trigger live stats
      }

      // Processed dates - track which dates have been scored (idempotency)
      match /processedDates/{dateId} {
        allow read: if isInLeague(leagueId);
        allow write: if isLeagueAdmin(leagueId); // Only admin can mark dates or clear them
      }

      // Chat bans - only league admin can manage banned users
      match /chatBans/{userId} {
        allow read, write: if isLeagueAdmin(leagueId);
      }

      // League chat messages - simple league-wide chat
      match /chatMessages/{messageId} {
        // Any authenticated league user in this league can read messages
        allow read: if isInLeague(leagueId);

        // Only non-banned league users can send messages
        allow create: if isInLeague(leagueId) && !isChatBanned(leagueId);

        // Allow delete/update only for league admin (moderation)
        allow delete, update: if isLeagueAdmin(leagueId);
      }
    }
    
    // Drafted players - linked to specific league
    match /draftedPlayers/{playerId} {
      // Anyone can read to see who's been drafted
      allow read: if isSignedIn();
      
      // Only authenticated users can draft (checked in code for turn)
      allow create: if isSignedIn() && 
                      request.resource.data.leagueId != null;
      
      // Only league admin can delete (for draft reset)
      // Note: resource.data is the existing document before deletion
      allow delete: if isSignedIn() && 
                      resource.data.leagueId != null &&
                      isLeagueAdmin(resource.data.leagueId);
      
      // Allow updates for roster slot management (active/reserve swaps)
      // Only allow changing rosterSlot and pendingSlot fields
      allow update: if isSignedIn() && 
                      resource.data.leagueId != null &&
                      isInLeague(resource.data.leagueId) &&
                      request.resource.data.diff(resource.data).affectedKeys().hasOnly(['rosterSlot', 'pendingSlot', 'lastSwapDate']);
    }
    
    // Draft state - per league
    match /drafts/{leagueId} {
      // Anyone in league can read draft state
      allow read: if isInLeague(leagueId);
      
      // Only league admin can create/update draft (initialize, advance pick)
      // In practice, any league member advances the pick when they draft
      allow create, update: if isInLeague(leagueId);
      
      // Only admin can delete (reset draft)
      allow delete: if isLeagueAdmin(leagueId);
    }
    
    // Deny everything else by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
